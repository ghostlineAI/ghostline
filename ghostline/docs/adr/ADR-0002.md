# ADR-0002: Compute Platform Selection - AWS ECS Fargate

**Status**: APPROVED  
**Date**: 2025-01-26  
**Decision Makers**: Engineering Team

## Context

GhostLine requires a compute platform that can:
- Scale from 0 to handle burst traffic (book generation is sporadic)
- Support long-running tasks (book generation takes hours)
- Run both web services (API) and background workers (Celery)
- Integrate seamlessly with AWS services (Bedrock, S3, RDS)
- Minimize operational overhead
- Support container-based deployments

## Decision

We will use **AWS ECS Fargate** as our default compute platform for all application workloads.

## Considered Alternatives

### 1. AWS ECS Fargate (SELECTED)
**Pros:**
- Serverless containers - no EC2 management
- Pay-per-use pricing model aligns with sporadic workload
- Native AWS integration (IAM, CloudWatch, VPC)
- Supports both web services and long-running tasks
- Auto-scaling built-in
- Spot instance support for cost optimization

**Cons:**
- Higher per-hour cost than EC2 (~20% premium)
- 4GB ephemeral storage limit (mitigated by EFS)
- Cold start time (~30-60 seconds)
- Limited CPU/memory configurations

### 2. AWS ECS on EC2
**Pros:**
- Lower per-hour compute cost
- Full control over instance types
- Local NVMe storage for caching
- No cold starts

**Cons:**
- Requires EC2 fleet management
- Fixed costs even during idle periods
- Patching and AMI management overhead
- Complex auto-scaling configuration

### 3. AWS Lambda
**Pros:**
- True pay-per-invocation
- Automatic scaling
- No infrastructure management

**Cons:**
- 15-minute execution limit (deal-breaker for book generation)
- 10GB memory limit
- Limited runtime environment control
- Complex for stateful operations

### 4. Kubernetes (EKS)
**Pros:**
- Industry-standard orchestration
- Maximum flexibility
- Multi-cloud portability

**Cons:**
- High operational complexity
- Requires Kubernetes expertise
- Higher baseline costs ($0.10/hour for control plane)
- Overkill for our use case

## Trade-off Analysis

| Criteria | Fargate | EC2 | Lambda | EKS |
|----------|---------|-----|--------|-----|
| Operational Overhead | Low | Medium | Very Low | High |
| Cost at Scale | Medium | Low | High | Medium |
| Cost when Idle | Very Low | High | Zero | Medium |
| Long Task Support | Excellent | Excellent | Poor | Excellent |
| Time to Market | Fast | Medium | Fast | Slow |
| Team Expertise Needed | Low | Medium | Low | High |

## Architecture Implications

### Service Deployment Pattern
```yaml
# API Service (Always On)
- CPU: 1 vCPU
- Memory: 2 GB
- Min Tasks: 2 (for HA)
- Max Tasks: 20
- Target CPU: 70%

# Worker Service (Scale to Zero)
- CPU: 4 vCPU  
- Memory: 8 GB
- Min Tasks: 0
- Max Tasks: 50
- Scale based on SQS queue depth
```

### Cost Optimization Strategy
1. Use Fargate Spot for worker tasks (70% discount)
2. Scale workers to zero when idle
3. Right-size task definitions based on profiling
4. Use S3/EFS for data instead of container storage

### Monitoring & Observability
- CloudWatch Container Insights for metrics
- X-Ray for distributed tracing
- CloudWatch Logs for centralized logging
- Custom metrics for book generation progress

## Migration Path

If we need to migrate away from Fargate:
1. **To EC2**: Change launch type in task definitions
2. **To Lambda**: Refactor into smaller, event-driven functions
3. **To EKS**: Deploy Fargate tasks to EKS with minimal changes

## Decision Outcome

Fargate provides the optimal balance of:
- **Developer productivity** (no infrastructure management)
- **Cost efficiency** (scale-to-zero for workers)
- **Operational simplicity** (AWS-managed)
- **Time to market** (faster than EC2/EKS setup)

The 20% compute premium over EC2 is justified by:
- Eliminated EC2 management overhead
- Better resource utilization (no idle instances)
- Reduced engineering time on infrastructure

## Review Schedule

This decision will be reviewed:
- After 3 months of production usage
- When monthly AWS bill exceeds $10,000
- If book generation time exceeds SLA (7 days)

## References

- [AWS Fargate Pricing](https://aws.amazon.com/fargate/pricing/)
- [ECS Best Practices Guide](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/)
- [Fargate vs EC2 Cost Analysis](https://www.trek10.com/blog/fargate-pricing-vs-ec2) 